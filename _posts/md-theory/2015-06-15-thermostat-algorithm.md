---
layout: post
title: Thermostat Algorithm 温度制御
date: 2015-06-15
category: md-theory
---

Molecular Dynamics の温度制御について述べる。

## なぜ温度制御をするのか

Molecular Dynamics (MD) Simulation は基本的には Newton 方程式に従って行われる。 Newton 方程式では (外力がない限り) エネルギーが保存されるため、系は数値誤差を除くと microcanonical (NVE) ensemble に従う。 このようなMDを Newtonian Dynamics と呼ぶ。

しかし現実の実験系ではエネルギーよりも温度が一定であることのほうが多く、エネルギー \\( E_{total} \\) は canonical ensemble に従って変化する。 このような状態をMD上に実現することが温度制御の目的である。

##「理想的」な温度制御

Canonical Ensemble に従う系の定義は以下のようなものである。

- 「系」は、自身よりも十分大きな「外界」と熱的に接触している（熱浴）
- 系と外界をあわせた全体は NVE に従う

これに準拠すると、理想的な温度制御とは、本当に「外界」を用意してしまうことである。 しかし、系でさえ数万粒子あるのに、それよりも「十分大きい」外界を用意するのは馬鹿げている。 このためアドホックな温度制御が必要となる。

## 実際の温度制御

MDの温度制御はエアコンの温度制御に近い。
設定温度 \\( T\_0 \\) と室内温度 \\( T \\) が存在し、
\\( T < T\_0 \\) であれば温度を上げ、\\( T > T\_0 \\) であれば温度を下げる。

いま設定温度 \\( T\_0 \\) は given な値だが、室内温度 \\( T \\) はどう定義すればよいだろうか。
そもそも「温度」とは本質的にマクロな物理量である。
「微視的状態がたくさん集まったアンサンブル」を見て「この系の温度は \\( T \\) だ」と言うのが本当であり、
MD 中の1個のスナップショットを見て「この分子配置だと温度は \\( T \\) だ」などというのはナンセンスである。

しかし微視的状態にバイアスをかけて温度を制御をする以上は、なんらかの「温度らしきもの」を与えなければならない。
そこで運動エネルギーが等分配則に従うと勝手に仮定すれば

\\[ K = \frac{1}{2}mv^2 = \frac{3}{2}k\_BT \\]

となる。運動エネルギー \\( K \\) は粒子の速度から計算できるため、これを用いて温度を「定義」してしまおう。
このような温度を「微視的温度」と勝手に呼ぶことにする。

あとは simulation 中の各瞬間の微視的温度 \\(T\\) が設定温度 \\(T\_0\\) より高いか低いかを判定し、低ければ各粒子の速度を上げ、高ければ下げてやればよい。
この上げ下げの詳細な手順が温度制御アルゴリズムである。

## 代表的な温度制御アルゴリズム

温度制御アルゴリズムは velocity scaling と velocity randomizing に大別できる。

Velocity scaling では、微視的温度 \\( T \\) に従うように全粒子の速度に定数をかける (スケールする)。 
このため「右に動いていた粒子が、唐突に上に動く」というような事はない。あくまでスケールするだけである。

Velocity randomization はそのような一様なスケールではなく、ランダムさをもった変化を導入する。

# velocity scaling

最も安直な velocity scaling は、微視的温度 \\(T\\) が設定温度 \\(T\_0\\) を一致するようにスケールさせるものである。 
これは実装が簡単だが、温度が不連続的に変化してよからぬ事が起きる。

これをもう少しマイルドにしたのが Berendsen thermostat である。
これは

\\[	\frac{dT}{dt} = \tau ^{-1} ( T\_0 - T ) \\]

という式に従って、微視的温度を設定温度に連続的に近づける。
この際の時定数が \\( \tau \\) であり、つまりこれが温度制御の「強さ」を表す (短いほど強い)。

さらに、この減衰方式にいくらかのランダム性を加えたのが Bussi らによる stochastic rescaling であり、これは運動エネルギー \\( K \\) を

\\[ dK = (K\_0 - K) \frac{dt}{\tau_T} + 2 \sqrt{ \frac{K\_0}{N\_f} } \frac{ dW }{ \sqrt{ \tau\_T } } \\]

という式に従って減衰させる。ここで \\( dW \\) は Wiener process noise term と呼ばれるランダム項である。

# velocity randomizing 

Andersen thermostat は1 stepごとにいくつかの粒子を選び、それらが canonical ensemble に従うように速度をランダムに再定義する。
簡単だが身もフタもない温度制御である。 
このとき、1回ごとに選ばれる粒子の割合が制御の強さに相当する。

一方、1 stepごとに全体のうち 1/N の粒子を選択するのではなく、N step ごとに全粒子の速度をランダムに再配置するというものもある。
これを massive Andersen thermostat という。

Implicit solvent 系では Langevin Dynamics という方法が用いられる。
これは溶媒の衝突をランダム力として擬似的に表現したモデルで、 Newton 方程式に「摩擦項」と「ランダム力項」を加えた

\\[ m\_i \frac{ d^2 \bf{r}\_i }{ dt^2 } = -m\_i\xi\_i \frac{ d\bf{r}\_i }{ dt } + \bf{F}\_i(\bf{r}\_i) + \hat{r}\_i \\]

と表現される。
第一項が速度に比例する摩擦、第二項が通常のポテンシャル力、第三項がランダム力である。

## Ref

- 上田顕, 「分子シミュレーション―古典系から量子系手法まで」(裳華房)
- [Basconi and Shirts, JCTC 2013](http://pubs.acs.org/doi/abs/10.1021/ct400109a)


